// Schéma de base de données pour l'appel internat
// PostgreSQL pour production (Supabase) / SQLite pour dev local

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Utilisateurs : AED, CPE, Manager ou Superadmin
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String // Hash bcrypt du mot de passe
  nom       String
  prenom    String
  role       String   @default("aed") // "aed", "cpe", "manager" ou "superadmin"
  niveau     String? // "6eme", "5eme", etc. NULL pour cpe/manager/superadmin (accès à tous)
  sexeGroupe String? // "M" ou "F" - quel groupe (garçons/filles) l'AED gère. NULL pour cpe/manager/superadmin
  createdAt  DateTime @default(now())

  appels Appel[] // Relation : 1 utilisateur fait plusieurs appels
  observationsGroupes ObservationGroupe[] // Relation : 1 utilisateur fait plusieurs observations de groupe
}

// Élèves de l'internat
model Eleve {
  id        String   @id @default(uuid())
  nom       String
  prenom    String
  niveau    String // "6eme", "5eme", etc.
  sexe      String // "M" ou "F"
  actif     Boolean  @default(true) // Pour archiver les élèves partis
  createdAt DateTime @default(now())

  appels Appel[] // Relation : 1 élève a plusieurs appels
}

// Enregistrement de présence quotidien
model Appel {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  niveau      String // Copié depuis eleve.niveau pour faciliter les filtres
  statut      String // "present", "acf", "absent"
  observation String? // Texte libre pour les remarques de la nuit (HISTORIQUE - plus utilisé pour nouveau flux)

  eleveId String
  eleve   Eleve  @relation(fields: [eleveId], references: [id], onDelete: Cascade)

  aedId String
  aed   User   @relation(fields: [aedId], references: [id])

  @@unique([eleveId, date]) // 1 élève = 1 seul appel par jour
  @@index([date]) // Index pour requêtes rapides par date
  @@index([niveau]) // Index pour filtrer par niveau
}

// Observations par groupe (niveau + sexe) pour l'appel du soir
model ObservationGroupe {
  id         String   @id @default(uuid())
  date       DateTime // Date de l'appel
  niveau     String // "6eme", "5eme", etc.
  sexeGroupe String // "M" ou "F"
  observation String? // Observation du groupe pour cette nuit
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  aedId String
  aed   User   @relation(fields: [aedId], references: [id])

  @@unique([date, niveau, sexeGroupe]) // 1 seule observation par groupe par jour
  @@index([date])
  @@index([niveau])
}

// Récapitulatifs générés par LLM
model Recap {
  id        String   @id @default(uuid())
  date      DateTime @unique // Date de la nuit concernée - 1 récap par jour
  contenu   String // Résumé généré par Claude/GPT (structuré par niveau)
  createdAt DateTime @default(now()) // Quand le récap a été généré

  @@index([date])
}
